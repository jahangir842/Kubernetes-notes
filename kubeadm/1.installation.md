## Install Kubernetes Cluster with Kubeadm

---

## **Architecture Overview**
You will set up a Kubernetes cluster using `kubeadm` with the following architecture:

- **Host Machine:** Ubuntu (High-End System)
- **Virtual Machines:**  
  - **1 Control Plane Node (Master)**
  - **2 Worker Nodes**
- **Operating System on VMs:** AlmaLinux 9
- **Networking:** Flannel (or Calico for network policies)
- **Container Runtime:** Containerd
- **Pod Network CIDR:** `192.168.1.0/16`
- **Kubernetes Version:** Latest stable

---

## **Step-by-Step Guide to Deploy Kubernetes on AlmaLinux using kubeadm**

### **Step 1: Install VirtualBox and Create Virtual Machines**

#### **1.1 Install VirtualBox (if not installed)**
If VirtualBox is not installed, run:
```bash
sudo apt update
sudo apt install virtualbox virtualbox-ext-pack -y
```

### **1.2 Create Three Virtual Machines**
1. Open VirtualBox and create **three VMs** with the following specs:
   - **VM Name:** `master-node`, `worker-node1`, `worker-node2`
   - **OS:** AlmaLinux 9
   - **CPU:** At least 2 vCPUs
   - **RAM:** 4GB minimum (8GB recommended)
   - **Storage:** 30GB (Dynamically allocated)
   - **Network:** **Bridged Adapter** (or Host-Only Adapter for local testing)

**Attach ISO & Install AlmaLinux 9** on all VMs.

---

### Update System:  

```bash
sudo dnf update -y && sudo dnf upgrade -y
sudo reboot
cat /etc/os-release  # Verify update
```

(Optional cleanup):  
```bash
sudo dnf autoremove -y && sudo dnf clean all
```

---

### **Set Hostnames & Static IPs**  
   Modify `/etc/hostname` on each VM:
   ```bash
   echo "master-node" | sudo tee /etc/hostname
   ```

---
### **enable **port 22** (SSH)**

To enable **port 22** (SSH) with **firewalld**, use the following guide:

https://github.com/jahangir842/linux-notes/blob/main/firewall/firewalld.md

---
### Static IPs

To Set static IP addresses, use the following guide:

https://github.com/jahangir842/linux-notes/blob/main/networking/configure_static_ip_in_RHEL_based_new.md

---

### **1. Update the `/etc/hosts` file**  
Edit the `/etc/hosts` file on **all nodes** (Master and Workers) using:  
```bash
sudo nano /etc/hosts
```
Add the following lines:
```
192.168.1.181  master-node
192.168.1.182  worker-node-1
192.168.1.183  worker-node-2
```
Save and exit (`CTRL+X`, then `Y`, then `ENTER`).

---

### **Disable Swap on all nodes:**

   ```bash
   sudo swapoff -a
   sudo sed -i '/swap/d' /etc/fstab
   ```

---

## **Step 2: Install Required Dependencies**
Perform the following steps on **all three nodes** to set up a stable Kubernetes environment.


### **1. Update System Packages**
Keeping the system updated ensures that you have the latest security patches and bug fixes.
```bash
sudo dnf update -y
```

### **2. Configure SELinux (Set to Permissive Mode)**
Kubernetes does not work well with SELinux in **Enforcing** mode by default, so we set it to **Permissive**.

**Selinux Notes:** https://github.com/jahangir842/linux-notes/blob/main/selinux/1.Introduction_selinux.md

#### Check the status:

```bash
sudo getenforce
```

#### **Temporarily Disable SELinux (Immediate Effect)**
```bash
sudo setenforce 0
```
- This command **temporarily** sets SELinux to **Permissive mode** until the next reboot.

#### **Permanently Disable SELinux (After Reboot)**
```bash
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
```
- This modifies `/etc/selinux/config` to ensure SELinux remains **Permissive** even after a reboot.

### **3. Enable IP Forwarding**
IP forwarding is essential for Kubernetes networking to function correctly.

#### **Create a Configuration File**
```bash
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
```
- **`net.bridge.bridge-nf-call-iptables = 1`** â†’ Ensures traffic passes through `iptables` rules for filtering.
- **`net.bridge.bridge-nf-call-ip6tables = 1`** â†’ Same as above but for IPv6.
- **`net.ipv4.ip_forward = 1`** â†’ Enables packet forwarding for Kubernetes networking.

#### **Apply the Changes Immediately**
```bash
sudo sysctl --system
```
- This reloads system kernel parameters from all config files (`/etc/sysctl.d/`).

### **4. Install Container Runtime (containerd)**
Kubernetes requires a **container runtime** to run its workloads. We will use **containerd**.

#### **Install containerd**

**Official Link:** https://docs.docker.com/engine/install/centos/

**Note:** The containerd is provided to linux package managers from Docker.

#### Set up the repository

Install the dnf-plugins-core package (which provides the commands to manage your DNF repositories) and set up the repository.
```bash
sudo dnf -y install dnf-plugins-core
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
```

```bash
sudo dnf install -y containerd.io
```
- Installs the **container runtime**.

#### **Configure containerd**


2. **Enable CRI Plugin**

Edit the following config file of containerd:

```bash
sudo nano /etc/containerd/config.toml
```

Verify the following plugin is not disabled.

```bash
#disabled_plugins = ["cri"]
```

#### **Restart and Enable containerd**
```bash
sudo systemctl restart containerd
sudo systemctl enable containerd
```
- **Restart** containerd to apply the configuration.
- **Enable** it to start automatically at boot.

### Create Containerd Configuration(If not created automatically)

```bash
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
```
- Creates the necessary **configuration directory** (`/etc/containerd`).
- Generates and saves the default **containerd configuration**.

---

### **Step 3: Install Kubernetes Components**

- **Install Kubeadm:** https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
- **Creating a cluster with kubeadm:** https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/

1. **Add Kubernetes Repository**
  This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo
  ```bash
  cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
  [kubernetes]
  name=Kubernetes
  baseurl=https://pkgs.k8s.io/core:/stable:/v1.32/rpm/
  enabled=1
  gpgcheck=1
  gpgkey=https://pkgs.k8s.io/core:/stable:/v1.32/rpm/repodata/repomd.xml.key
  exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
  EOF
  ```

2. **Install Kubernetes Components**
   ```bash
   sudo dnf install -y kubeadm kubelet kubectl
   sudo systemctl enable kubelet
   ```

---
### Lock Kubernetes Versions:
 
To prevent Kubernetes from updating on AlmaLinux:  

1. **Lock Kubernetes version:**  
   ```bash
   sudo dnf install -y dnf-plugins-core
   sudo dnf versionlock add kubelet kubeadm kubectl containerd.io
   ```

2. **Exclude from updates (Alternative):**  
   Add this to `/etc/dnf/dnf.conf`:  
   ```
   exclude=kubelet kubeadm kubectl
   ```

3. **Verify lock:**  
   ```bash
   sudo dnf versionlock list
   ```

Now, `dnf update` wonâ€™t update Kubernetes. âœ…

---

### **Step 2: Set Up Networking (Flannel)**
```bash
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```


---

## **Summary**
- Installed VirtualBox and created 3 VMs.
- Configured AlmaLinux with static IPs and disabled swap.
- Installed `containerd`, `kubeadm`, `kubectl`, and `kubelet`.
- Initialized Kubernetes on the master node.
- Deployed a Flannel network and joined worker nodes.

Now you have a **fully functional Kubernetes cluster** running on AlmaLinux VMs in VirtualBox! ðŸš€
